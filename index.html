<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #28a745;
            --secondary: #218838;
            --accent: #4cc9f0;
            --danger: #f72585;
            --success: #28a745;
            --warning: #fd7e14;
            --dark: #212529;
            --light: #f8faf8;
            --gray: #6c757d;
            --chart1: #28a745;
            --chart2: #20c997;
            --chart3: #6f42c1;
            --chart4: #ffc107;
            --chart5: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .connection-status {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-good {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-bad {
            background-color: var(--danger);
            box-shadow: 0 0 8px var(--danger);
        }

        .last-update {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--primary);
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-info {
            background-color: var(--chart5);
            color: white;
        }

        .signal-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .signal {
            text-align: center;
            width: 45%;
        }

        .signal-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--gray);
        }

        .signal-lights {
            background-color: var(--dark);
            border-radius: 15px;
            padding: 20px;
            width: 100px;
            margin: 0 auto 15px;
        }

        .light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 10px auto;
            opacity: 0.2;
            transition: all 0.3s;
        }

        .light.red { background-color: var(--danger); }
        .light.yellow { background-color: var(--warning); }
        .light.green { background-color: var(--success); }

        .light.active {
            opacity: 1;
            box-shadow: 0 0 20px 5px rgba(255,255,255,0.3);
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            color: var(--primary);
        }

        .vehicle-count {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--dark);
        }

        .vehicle-difference {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .difference-positive {
            color: var(--success);
        }

        .difference-negative {
            color: var(--danger);
        }

        .sensor-value {
            font-size: 1.5rem;
            font-weight: 500;
            margin: 5px 0;
        }

        .sensor-label {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        .chart-description {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 10px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .data-item {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .transition-alert {
            background-color: rgba(248, 150, 30, 0.1);
            color: var(--warning);
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .transition-timer {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 5px 0;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .emergency-alert {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Road Visualization Styles */
        .road-container {
            width: 100%;
            height: 300px;
            position: relative;
            margin: 20px 0;
            background-color: #f0f0f0;
            overflow: hidden;
        }

        .road {
            position: absolute;
            background-color: #333;
        }

        .horizontal-road {
            width: 100%;
            height: 40px;
            top: 50%;
            transform: translateY(-50%);
        }

        .vertical-road {
            width: 40px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .intersection {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #444;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        .stop-line {
            position: absolute;
            background-color: white;
            z-index: 3;
        }

        .stop-line.horizontal {
            width: 10px;
            height: 5px;
            left: calc(50% - 20px);
            top: calc(50% - 2.5px);
        }

        .stop-line.vertical {
            width: 5px;
            height: 10px;
            left: calc(50% - 2.5px);
            top: calc(50% - 20px);
        }

        .vehicle {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            z-index: 3;
        }

        .horizontal-vehicle {
            background-color: #4cc9f0;
            top: calc(50% - 10px);
        }

        .vertical-vehicle {
            background-color: #f72585;
            left: calc(50% - 10px);
        }

        .difference-display {
    position: absolute;
    font-size: 0.9rem;
    color: black;
    z-index: 4;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 5px 10px;
    border-radius: 8px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.horizontal-difference {
    top: 20px;        /* Moved to top left corner */
    left: 20px;
}

.vertical-difference {
    top: 20px;        /* Moved to top right corner */
    right: 20px;
}

        /* Data History Table Styles */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .history-table th, .history-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .history-table th {
            background-color: var(--light);
            font-weight: 500;
        }

        .history-table tr:hover {
            background-color: rgba(40, 167, 69, 0.05);
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .signal-container {
                flex-direction: column;
                gap: 20px;
            }

            .signal {
                width: 100%;
            }

            .control-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Smart Traffic Management System</h1>
            <p class="subtitle">IoT-Enabled Decentralized Federated Learning for Real-Time Traffic Prediction</p>
        </header>

        <div class="status-bar">
            <div class="connection-status">
                <div class="status-indicator status-good" id="connection-indicator"></div>
                <span id="connection-status">Connected</span>
            </div>
            <div class="last-update">Last updated: <span id="last-update">Never</span></div>
        </div>

        <div class="dashboard-grid">
            <!-- Traffic Signals Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Adaptive Traffic Signals</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" id="refresh-btn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="transition-alert" id="transition-alert">
                    <div>Signal transition in progress</div>
                    <div class="transition-timer" id="transition-timer">5</div>
                    <div>Please wait...</div>
                </div>

                <div class="emergency-alert" id="emergency-alert">
                    <div><i class="fas fa-ambulance"></i> Emergency vehicle detected</div>
                    <div>Priority signal activated</div>
                </div>

                <div class="signal-container">
                    <div class="signal">
                        <div class="signal-title">Horizontal Road</div>
                        <div class="signal-lights">
                            <div class="light red active" id="signal1-red"></div>
                            <div class="light yellow" id="signal1-yellow"></div>
                            <div class="light green" id="signal1-green"></div>
                        </div>
                        <div class="vehicle-difference" id="difference1">Difference: 0</div>
                    </div>

                    <div class="signal">
                        <div class="signal-title">Vertical Road</div>
                        <div class="signal-lights">
                            <div class="light red" id="signal2-red"></div>
                            <div class="light yellow" id="signal2-yellow"></div>
                            <div class="light green active" id="signal2-green"></div>
                        </div>
                        <div class="vehicle-difference" id="difference2">Difference: 0</div>
                    </div>
                </div>
            </div>

            <!-- Road Visualization Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Traffic Flow Visualization</h2>
                </div>
                <div class="road-container">
                    <div class="road horizontal-road"></div>
                    <div class="road vertical-road"></div>
                    <div class="intersection"></div>
                    <div class="stop-line horizontal"></div>
                    <div class="stop-line vertical"></div>
                    <div class="difference-display horizontal-difference">Horizontal Difference: <span id="road-diff1">0</span></div>
                    <div class="difference-display vertical-difference">Vertical Difference: <span id="road-diff2">0</span></div>
                    <!-- Vehicles will be added dynamically -->
                </div>
                <div class="chart-description">
                    Real-time visualization of vehicle movement. Blue vehicles represent horizontal road traffic,
                    pink vehicles represent vertical road traffic. Vehicles stop at red lights and move through green lights.
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Sensor Data Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Real-time Sensor Data</h2>
                </div>
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                    <p class="chart-description">Current sensor readings from both directions</p>
                </div>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="sensor-label">Ultrasonic Sensor 1</div>
                        <div class="sensor-value" id="ultrasonic1-value">0 cm</div>
                    </div>
                    <div class="data-item">
                        <div class="sensor-label">Ultrasonic Sensor 2</div>
                        <div class="sensor-value" id="ultrasonic2-value">0 cm</div>
                    </div>
                    <div class="data-item">
                        <div class="sensor-label">Total Vehicles</div>
                        <div class="sensor-value" id="total-vehicles">0</div>
                    </div>
                    <div class="data-item">
                        <div class="sensor-label">Last Update</div>
                        <div class="sensor-value" id="data-timestamp">--:--:--</div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Count Trends Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Vehicle Count Trends</h2>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                    <p class="chart-description">Historical vehicle counts with 30-minute predictions</p>
                </div>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="sensor-label">Current Flow Rate</div>
                        <div class="sensor-value" id="flow-rate">0/min</div>
                    </div>
                    <div class="data-item">
                        <div class="sensor-label">Congestion Level</div>
                        <div class="sensor-value" id="congestion-level">Low</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Data History Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Historical Data</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary" id="refresh-history">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Horizontal</th>
                                <th>Vertical</th>
                                <th>US1 (cm)</th>
                                <th>US2 (cm)</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <!-- Data will be added dynamically -->
                        </tbody>
                    </table>
                </div>
                <p class="chart-description">Last 10 readings from the intersection sensors</p>
            </div>

            <!-- Traffic Flow Analysis Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Traffic Flow Analysis</h2>
                </div>
                <div class="chart-container">
                    <canvas id="flowChart"></canvas>
                    <p class="chart-description">Actual traffic flow (vehicles/min) for both directions</p>
                </div>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="sensor-label">Peak Time Today</div>
                        <div class="sensor-value" id="peak-time">--:--</div>
                    </div>
                    <div class="data-item">
                        <div class="sensor-label">Max Vehicles</div>
                        <div class="sensor-value" id="max-vehicles">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Emergency Management Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Emergency Management</h2>
                </div>
                <div class="chart-container">
                    <canvas id="emergencyChart"></canvas>
                    <p class="chart-description">Emergency vehicle detection events</p>
                </div>
                <div class="control-buttons">
                    <button class="btn btn-primary" id="simulate-emergency">
                        <i class="fas fa-ambulance"></i> Simulate Emergency
                    </button>
                    <button class="btn btn-secondary" id="reset-emergency">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Manual Control Card -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Manual Control Panel</h2>
                </div>
                <div class="control-buttons">
                    <button class="btn btn-primary" id="manual-green1">
                        <i class="fas fa-traffic-light"></i> Green - Horizontal
                    </button>
                    <button class="btn btn-primary" id="manual-green2">
                        <i class="fas fa-traffic-light"></i> Green - Vertical
                    </button>
                    <button class="btn btn-warning" id="manual-yellow">
                        <i class="fas fa-traffic-light"></i> Emergency Yellow
                    </button>
                </div>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="sensor-label">Current Mode</div>
                        <div class="sensor-value" id="current-mode">Automatic</div>
                    </div>
                    <div class="data-item">
                        <div class="sensor-label">Last Manual Command</div>
                        <div class="sensor-value" id="last-command">None</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            IoT-Enabled Smart Traffic Management System &copy; 2025 | Real-Time Traffic Monitoring and Adaptive Control
        </div>
    </div>

    <script>
        // System state
        const state = {
            signals: {
                signal1: {
                    color: 'red',
                    count: 0,
                    prevCount: 0,
                    movingVehicles: 0,
                    vehicles: []
                },
                signal2: {
                    color: 'green',
                    count: 0,
                    prevCount: 0,
                    movingVehicles: 0,
                    vehicles: []
                }
            },
            transition: {
                active: false,
                timer: null,
                secondsLeft: 0,
                changingSignal: null
            },
            charts: {
                sensor: null,
                trend: null,
                flow: null,
                emergency: null
            },
            manualMode: false,
            lastCommand: null,
            emergencyMode: false,
            historicalData: [],
            emergencyEvents: [0, 0, 0],
            dataHistory: [],
            refreshInterval: null,
            vehiclePositions: {
                horizontal: [],
                vertical: []
            }
        };

        // Initialize charts
        function initCharts() {
            // Sensor Chart
            state.charts.sensor = new Chart(
                document.getElementById('sensorChart'),
                {
                    type: 'bar',
                    data: {
                        labels: ['Horizontal', 'Vertical', 'US1', 'US2'],
                        datasets: [{
                            label: 'Current Values',
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(32, 201, 151, 0.7)',
                                'rgba(108, 117, 125, 0.7)',
                                'rgba(111, 66, 193, 0.7)'
                            ],
                            borderColor: [
                                'rgba(40, 167, 69, 1)',
                                'rgba(32, 201, 151, 1)',
                                'rgba(108, 117, 125, 1)',
                                'rgba(111, 66, 193, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                }
            );

            // Trend Chart
            state.charts.trend = new Chart(
                document.getElementById('trendChart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Horizontal',
                                data: [],
                                borderColor: 'var(--chart1)',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Vertical',
                                data: [],
                                borderColor: 'var(--chart2)',
                                backgroundColor: 'rgba(32, 201, 151, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                }
            );

            // Flow Chart
            state.charts.flow = new Chart(
                document.getElementById('flowChart'),
                {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Horizontal Flow',
                                data: [],
                                borderColor: 'var(--chart3)',
                                backgroundColor: 'rgba(111, 66, 193, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Vertical Flow',
                                data: [],
                                borderColor: 'var(--chart4)',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                }
            );

            // Emergency Chart
            state.charts.emergency = new Chart(
                document.getElementById('emergencyChart'),
                {
                    type: 'bar',
                    data: {
                        labels: ['Last Week', 'Last 24h', 'Today'],
                        datasets: [{
                            label: 'Emergency Events',
                            data: [0, 0, 0],
                            backgroundColor: 'rgba(247, 37, 133, 0.7)',
                            borderColor: 'rgba(247, 37, 133, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                }
            );
        }

        // Update signal display
        function updateSignalDisplay(signal) {
            document.getElementById(`${signal}-red`).classList.remove('active');
            document.getElementById(`${signal}-yellow`).classList.remove('active');
            document.getElementById(`${signal}-green`).classList.remove('active');
            document.getElementById(`${signal}-${state.signals[signal].color}`).classList.add('active');
        }

        // Set signal color
        function setSignalColor(signal, color) {
            state.signals[signal].color = color;
            updateSignalDisplay(signal);
        }

        // Check if signals need to change based on vehicle count differences
        function checkForSignalChange() {
            if (state.manualMode || state.transition.active || state.emergencyMode) return;

            const diff1 = state.signals.signal1.count - state.signals.signal1.prevCount;
            const diff2 = state.signals.signal2.count - state.signals.signal2.prevCount;

            if (Math.abs(diff1 - diff2) > 5) {
                const shouldBeGreen = diff1 > diff2 ? 'signal1' : 'signal2';
                if (state.signals[shouldBeGreen].color === 'green') return;
                startTransition(shouldBeGreen);
            }
        }

        // Start the transition process
        function startTransition(signalToChange) {
            state.transition.active = true;
            state.transition.changingSignal = signalToChange;
            state.transition.secondsLeft = 3;
            document.getElementById('transition-alert').style.display = 'block';
            document.getElementById('transition-timer').textContent = '3';

            state.transition.timer = setInterval(() => {
                state.transition.secondsLeft--;
                document.getElementById('transition-timer').textContent = state.transition.secondsLeft;

                if (state.transition.secondsLeft <= 1) {
                    setSignalColor('signal1', 'yellow');
                    setSignalColor('signal2', 'yellow');
                }

                if (state.transition.secondsLeft <= 0) {
                    completeTransition();
                }
            }, 1000);
        }

        // Complete the transition
        function completeTransition() {
            clearInterval(state.transition.timer);
            const newGreen = state.transition.changingSignal;
            const newRed = newGreen === 'signal1' ? 'signal2' : 'signal1';

            setSignalColor(newGreen, 'green');
            setSignalColor(newRed, 'red');
            document.getElementById('transition-alert').style.display = 'none';
            state.transition.active = false;
        }

        // Handle manual control
        function handleManualControl(command) {
            state.manualMode = true;
            state.lastCommand = command;
            document.getElementById('current-mode').textContent = "Manual";
            document.getElementById('last-command').textContent = command;

            switch(command) {
                case 'green1':
                    setSignalColor('signal1', 'green');
                    setSignalColor('signal2', 'red');
                    break;
                case 'green2':
                    setSignalColor('signal1', 'red');
                    setSignalColor('signal2', 'green');
                    break;
                case 'yellow':
                    setSignalColor('signal1', 'yellow');
                    setSignalColor('signal2', 'yellow');
                    break;
            }

            fetch('/manual_control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ signal: command })
            });
        }

        // Handle emergency vehicle detection
        function handleEmergency() {
            state.emergencyMode = true;
            state.emergencyEvents[2]++;
            document.getElementById('emergency-alert').style.display = 'block';
            document.getElementById('current-mode').textContent = "Emergency";
            setSignalColor('signal1', 'yellow');
            setSignalColor('signal2', 'yellow');
            state.charts.emergency.data.datasets[0].data = state.emergencyEvents;
            state.charts.emergency.update();
        }

        // Reset emergency mode
        function resetEmergency() {
            state.emergencyMode = false;
            document.getElementById('emergency-alert').style.display = 'none';
            document.getElementById('current-mode').textContent = "Automatic";
            if (!state.manualMode) {
                setSignalColor('signal1', 'red');
                setSignalColor('signal2', 'green');
            }
        }

        // Update road visualization with vehicles
        function updateRoadVisualization() {
    const roadContainer = document.querySelector('.road-container');
    const containerWidth = roadContainer.offsetWidth;
    const containerHeight = roadContainer.offsetHeight;

    // Clear existing vehicles
    document.querySelectorAll('.vehicle').forEach(v => v.remove());

    // Get current signal states
    const horizontalSignal = state.signals.signal1.color;
    const verticalSignal = state.signals.signal2.color;

    // Get the ACTUAL differences (ensure they're positive)
    const horizontalDifference = Math.max(0, state.signals.signal1.count - state.signals.signal1.prevCount);
    const verticalDifference = Math.max(0, state.signals.signal2.count - state.signals.signal2.prevCount);

    // Update difference displays
    document.getElementById('road-diff1').textContent = horizontalDifference;
    document.getElementById('road-diff2').textContent = verticalDifference;

    /* HORIZONTAL ROAD (Difference 1) */
    if (horizontalSignal === 'red') {
        // RED LIGHT - Show all vehicles compressed before intersection
        const vehicleCount = horizontalDifference;
        const approachWidth = containerWidth * 0.4; // Width before intersection
        const approachHeight = 40; // Fixed road height

        // Calculate grid layout (max 6 per row)
        const maxVehiclesPerRow = 6;
        const rows = Math.ceil(vehicleCount / maxVehiclesPerRow);
        const cols = Math.min(vehicleCount, maxVehiclesPerRow);

        // Calculate vehicle size (scale down if many vehicles)
        const vehicleSize = Math.min(20, (approachWidth / cols) * 0.8);
        const colSpacing = approachWidth / cols;

        // Position vehicles in grid before intersection
        for (let i = 0; i < vehicleCount; i++) {
            const row = Math.floor(i / maxVehiclesPerRow);
            const col = i % maxVehiclesPerRow;

            const vehicle = document.createElement('div');
            vehicle.className = 'vehicle horizontal-vehicle';
            vehicle.style.width = `${vehicleSize}px`;
            vehicle.style.height = `${vehicleSize}px`;
            vehicle.style.left = `${col * colSpacing}px`;
            vehicle.style.top = `${(containerHeight/2 - vehicleSize/2) + (row * (vehicleSize + 2))}px`;
            roadContainer.appendChild(vehicle);
        }

        // Clear any moving vehicle state
        state.vehiclePositions.horizontal = [];
    } else {
        // GREEN LIGHT - Moving vehicles
        const vehicleCount = horizontalDifference;

        // Initialize moving vehicles if not already done
        if (state.vehiclePositions.horizontal.length === 0 && vehicleCount > 0) {
            const vehicleSize = 15;
            const totalDistance = containerWidth + 20; // Full road width plus margin

            for (let i = 0; i < vehicleCount; i++) {
                state.vehiclePositions.horizontal.push({
                    x: -20 - (i * 30), // Start slightly off-screen with spacing
                    y: containerHeight/2 - vehicleSize/2,
                    size: vehicleSize,
                    speed: 2 + Math.random(),
                    removeTime: Date.now() + 6000 // Max 6 seconds to clear
                });
            }
        }

        // Update positions and remove expired vehicles
        const now = Date.now();
        state.vehiclePositions.horizontal = state.vehiclePositions.horizontal
            .filter(v => now < v.removeTime)
            .map(v => ({
                ...v,
                x: v.x + v.speed
            }));

        // Render moving vehicles
        state.vehiclePositions.horizontal.forEach(v => {
            if (v.x < containerWidth) { // Only show if on screen
                const vehicle = document.createElement('div');
                vehicle.className = 'vehicle horizontal-vehicle';
                vehicle.style.width = `${v.size}px`;
                vehicle.style.height = `${v.size}px`;
                vehicle.style.left = `${v.x}px`;
                vehicle.style.top = `${v.y}px`;
                roadContainer.appendChild(vehicle);
            }
        });

        // Schedule removal of vehicles (about 1 per second)
        if (!state.horizontalClearInterval && state.vehiclePositions.horizontal.length > 0) {
            state.horizontalClearInterval = setInterval(() => {
                if (state.vehiclePositions.horizontal.length > 0) {
                    state.vehiclePositions.horizontal.shift();
                } else {
                    clearInterval(state.horizontalClearInterval);
                    state.horizontalClearInterval = null;
                }
            }, 1000);
        }
    }

    /* VERTICAL ROAD (Difference 2) */
    if (verticalSignal === 'red') {
        // RED LIGHT - Show all vehicles compressed before intersection
        const vehicleCount = verticalDifference;
        const approachHeight = containerHeight * 0.4; // Height before intersection
        const approachWidth = 40; // Fixed road width

        // Calculate grid layout (max 6 per column)
        const maxVehiclesPerCol = 6;
        const cols = Math.ceil(vehicleCount / maxVehiclesPerCol);
        const rows = Math.min(vehicleCount, maxVehiclesPerCol);

        // Calculate vehicle size (scale down if many vehicles)
        const vehicleSize = Math.min(20, (approachHeight / rows) * 0.8);
        const rowSpacing = approachHeight / rows;

        // Position vehicles in grid before intersection
        for (let i = 0; i < vehicleCount; i++) {
            const col = Math.floor(i / maxVehiclesPerCol);
            const row = i % maxVehiclesPerCol;

            const vehicle = document.createElement('div');
            vehicle.className = 'vehicle vertical-vehicle';
            vehicle.style.width = `${vehicleSize}px`;
            vehicle.style.height = `${vehicleSize}px`;
            vehicle.style.left = `${(containerWidth/2 - approachWidth/2) + (col * (vehicleSize + 2))}px`;
            vehicle.style.top = `${row * rowSpacing}px`;
            roadContainer.appendChild(vehicle);
        }

        // Clear any moving vehicle state
        state.vehiclePositions.vertical = [];
    } else {
        // GREEN LIGHT - Moving vehicles
        const vehicleCount = verticalDifference;

        // Initialize moving vehicles if not already done
        if (state.vehiclePositions.vertical.length === 0 && vehicleCount > 0) {
            const vehicleSize = 15;
            const totalDistance = containerHeight + 20; // Full road height plus margin

            for (let i = 0; i < vehicleCount; i++) {
                state.vehiclePositions.vertical.push({
                    y: -20 - (i * 30), // Start slightly off-screen with spacing
                    x: containerWidth/2 - vehicleSize/2,
                    size: vehicleSize,
                    speed: 2 + Math.random(),
                    removeTime: Date.now() + 6000 // Max 6 seconds to clear
                });
            }
        }

        // Update positions and remove expired vehicles
        const now = Date.now();
        state.vehiclePositions.vertical = state.vehiclePositions.vertical
            .filter(v => now < v.removeTime)
            .map(v => ({
                ...v,
                y: v.y + v.speed
            }));

        // Render moving vehicles
        state.vehiclePositions.vertical.forEach(v => {
            if (v.y < containerHeight) { // Only show if on screen
                const vehicle = document.createElement('div');
                vehicle.className = 'vehicle vertical-vehicle';
                vehicle.style.width = `${v.size}px`;
                vehicle.style.height = `${v.size}px`;
                vehicle.style.left = `${v.x}px`;
                vehicle.style.top = `${v.y}px`;
                roadContainer.appendChild(vehicle);
            }
        });

        // Schedule removal of vehicles (about 1 per second)
        if (!state.verticalClearInterval && state.vehiclePositions.vertical.length > 0) {
            state.verticalClearInterval = setInterval(() => {
                if (state.vehiclePositions.vertical.length > 0) {
                    state.vehiclePositions.vertical.shift();
                } else {
                    clearInterval(state.verticalClearInterval);
                    state.verticalClearInterval = null;
                }
            }, 1000);
        }
    }
}

        // Update data history table
        function updateHistoryTable(data) {
            const historyBody = document.getElementById('history-body');
            const junction = data.junctions.junction_1;

            state.dataHistory.unshift({
                time: junction.timestamp.slice(8,10) + ':' + junction.timestamp.slice(10,12),
                count1: junction.vehicle_count1,
                count2: junction.vehicle_count2,
                us1: junction.ultrasonic1,
                us2: junction.ultrasonic2
            });

            if (state.dataHistory.length > 10) {
                state.dataHistory.pop();
            }

            historyBody.innerHTML = '';
            state.dataHistory.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.time}</td>
                    <td>${entry.count1}</td>
                    <td>${entry.count2}</td>
                    <td>${entry.us1}</td>
                    <td>${entry.us2}</td>
                `;
                historyBody.appendChild(row);
            });

            if (state.dataHistory.length > 0) {
                let maxCount = 0;
                let peakTime = '--:--';

                state.dataHistory.forEach(entry => {
                    const total = entry.count1 + entry.count2;
                    if (total > maxCount) {
                        maxCount = total;
                        peakTime = entry.time;
                    }
                });

                document.getElementById('peak-time').textContent = peakTime;
                document.getElementById('max-vehicles').textContent = maxCount;
            }
        }

        // Update charts with new data
        function updateCharts(data) {
            const junction = data.junctions.junction_1;
            const now = new Date();

            // Update sensor chart
            state.charts.sensor.data.datasets[0].data = [
                junction.vehicle_count1,
                junction.vehicle_count2,
                junction.ultrasonic1,
                junction.ultrasonic2
            ];
            state.charts.sensor.update();

            // Generate time labels
            const labels = [];
            for (let i = 30; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000);
                labels.push(time.getHours() + ':' + time.getMinutes().toString().padStart(2, '0'));
            }

            // Update trend chart
            if (state.historicalData.length >= 30) {
                state.historicalData.shift();
            }
            state.historicalData.push({
                count1: junction.vehicle_count1,
                count2: junction.vehicle_count2
            });

            state.charts.trend.data.labels = labels.slice(-state.historicalData.length);
            state.charts.trend.data.datasets[0].data = state.historicalData.map(d => d.count1);
            state.charts.trend.data.datasets[1].data = state.historicalData.map(d => d.count2);
            state.charts.trend.update();

            // Calculate flow rate
            const flowRate = Math.round((junction.vehicle_count1 + junction.vehicle_count2) / 5);
            document.getElementById('flow-rate').textContent = `${flowRate}/min`;

            // Set congestion level
            let congestionLevel = 'Low';
            if (flowRate > 30) congestionLevel = 'High';
            else if (flowRate > 15) congestionLevel = 'Medium';
            document.getElementById('congestion-level').textContent = congestionLevel;

            // Update flow chart
            if (state.historicalData.length >= 10) {
                const flowData1 = [];
                const flowData2 = [];

                for (let i = 1; i < state.historicalData.length; i++) {
                    flowData1.push(state.historicalData[i].count1 - state.historicalData[i-1].count1);
                    flowData2.push(state.historicalData[i].count2 - state.historicalData[i-1].count2);
                }

                state.charts.flow.data.labels = labels.slice(-flowData1.length);
                state.charts.flow.data.datasets[0].data = flowData1;
                state.charts.flow.data.datasets[1].data = flowData2;
                state.charts.flow.update();
            }

            // Update history table
            updateHistoryTable(data);
        }

        // Format time as HH:MM:SS
        function formatTime(date) {
            return date.getHours().toString().padStart(2, '0') + ':' +
                   date.getMinutes().toString().padStart(2, '0') + ':' +
                   date.getSeconds().toString().padStart(2, '0');
        }

        // Load data from backend
        function loadData() {
            fetch('/dashboard_data')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Update connection status
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-indicator').className = 'status-indicator status-good';

                    // Update last update time
                    document.getElementById('last-update').textContent = formatTime(new Date());
                    document.getElementById('data-timestamp').textContent =
                        data.junctions.junction_1.timestamp.slice(8,10) + ':' +
                        data.junctions.junction_1.timestamp.slice(10,12) + ':' +
                        data.junctions.junction_1.timestamp.slice(12,14);

                    // Update vehicle counts and differences
                    state.signals.signal1.prevCount = state.signals.signal1.count;
                    state.signals.signal2.prevCount = state.signals.signal2.count;

                    state.signals.signal1.count = data.junctions.junction_1.vehicle_count1;
                    state.signals.signal2.count = data.junctions.junction_1.vehicle_count2;

                    // Calculate differences
                    const diff1 = state.signals.signal1.count - state.signals.signal1.prevCount;
                    const diff2 = state.signals.signal2.count - state.signals.signal2.prevCount;

                    document.getElementById('difference1').textContent = `Difference: ${diff1 > 0 ? diff1 : 0}`;
                    document.getElementById('difference2').textContent = `Difference: ${diff2 > 0 ? diff2 : 0}`;

                    // Color differences
                    document.getElementById('difference1').className =
                        `vehicle-difference ${diff1 > 0 ? 'difference-positive' : 'difference-negative'}`;
                    document.getElementById('difference2').className =
                        `vehicle-difference ${diff2 > 0 ? 'difference-positive' : 'difference-negative'}`;

                    // Update ultrasonic values
                    document.getElementById('ultrasonic1-value').textContent =
                        `${data.junctions.junction_1.ultrasonic1} cm`;
                    document.getElementById('ultrasonic2-value').textContent =
                        `${data.junctions.junction_1.ultrasonic2} cm`;

                    // Update total vehicles
                    document.getElementById('total-vehicles').textContent = data.total_vehicles;

                    // Update road visualization
                    updateRoadVisualization();

                    // Update charts
                    updateCharts(data);

                    // Check if signals need to change
                    if (!state.manualMode && !state.emergencyMode) {
                        checkForSignalChange();
                    }
                })
                .catch(error => {
                    console.error("Error loading data:", error);
                    document.getElementById('connection-status').textContent = 'Disconnected';
                    document.getElementById('connection-indicator').className = 'status-indicator status-bad';
                    document.getElementById('last-update').textContent = 'Error';
                });
        }

        // Initialize the system
        function init() {
            initCharts();

            // Set initial signal states
            setSignalColor('signal1', 'red');
            setSignalColor('signal2', 'green');

            // Initialize emergency events data
            state.emergencyEvents = [
                Math.floor(Math.random() * 5), // Last week
                Math.floor(Math.random() * 3), // Last 24h
                0 // Today
            ];
            state.charts.emergency.data.datasets[0].data = state.emergencyEvents;
            state.charts.emergency.update();

            // Set up button event listeners
            document.getElementById('refresh-btn').addEventListener('click', loadData);
            document.getElementById('refresh-history').addEventListener('click', loadData);
            document.getElementById('manual-green1').addEventListener('click', () => handleManualControl('green1'));
            document.getElementById('manual-green2').addEventListener('click', () => handleManualControl('green2'));
            document.getElementById('manual-yellow').addEventListener('click', () => handleManualControl('yellow'));
            document.getElementById('simulate-emergency').addEventListener('click', handleEmergency);
            document.getElementById('reset-emergency').addEventListener('click', resetEmergency);

            // Start data refresh
            loadData();
            state.refreshInterval = setInterval(loadData, 3000); // Refresh every 3 seconds
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>